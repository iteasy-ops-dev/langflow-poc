# 🔤 한글 인코딩 문제 해결 가이드

## 📋 문제 상황

**증상**: 파일 업로드 시 한글이 깨져서 표시됨  
**원인**: FileReader가 인코딩을 명시하지 않으면 시스템 기본 인코딩 사용

---

## ✅ 적용된 해결 방법

### 1. **FileReader UTF-8 명시**

#### 수정 전 (문제 코드)
```typescript
const reader = new FileReader()
reader.onload = (event) => {
  const text = event.target?.result as string
  setDocumentText(text)
}
reader.readAsText(file)  // ❌ 인코딩 미지정
```

#### 수정 후 (해결 코드)
```typescript
const reader = new FileReader()
reader.onload = (event) => {
  const text = event.target?.result as string
  setDocumentText(text)
}
reader.readAsText(file, 'UTF-8')  // ✅ UTF-8 명시
```

### 2. **file.text() 대신 FileReader 사용**

#### 수정 전
```typescript
// file.text()는 인코딩 지정 불가
const text = await file.text()
const json = JSON.parse(text)
```

#### 수정 후
```typescript
const reader = new FileReader()
reader.onload = (event) => {
  const text = event.target?.result as string
  const json = JSON.parse(text)
  setLogText(JSON.stringify(json, null, 2))
}
reader.readAsText(file, 'UTF-8')
```

### 3. **PapaParse CSV 인코딩 설정**

```typescript
Papa.parse(text, {
  encoding: 'UTF-8',          // ✅ 인코딩 명시
  skipEmptyLines: true,       // 빈 줄 제거
  complete: (results) => {
    // 처리 로직
  }
})
```

---

## 🔍 인코딩 감지 유틸리티

복잡한 인코딩 환경을 위한 자동 감지 기능:

```typescript
// frontend/lib/encoding.ts
export async function detectEncoding(file: File): Promise<string> {
  const arrayBuffer = await file.arrayBuffer()
  const bytes = new Uint8Array(arrayBuffer).slice(0, 100)
  
  // BOM 체크
  if (bytes[0] === 0xEF && bytes[1] === 0xBB && bytes[2] === 0xBF) {
    return 'UTF-8'
  }
  
  if (bytes[0] === 0xFE && bytes[1] === 0xFF) {
    return 'UTF-16BE'
  }
  
  if (bytes[0] === 0xFF && bytes[1] === 0xFE) {
    return 'UTF-16LE'
  }
  
  // 기본값
  return 'UTF-8'
}

export async function readFileWithEncoding(
  file: File, 
  encoding?: string
): Promise<string> {
  if (!encoding) {
    encoding = await detectEncoding(file)
  }
  
  return new Promise((resolve, reject) => {
    const reader = new FileReader()
    reader.onload = (event) => {
      resolve(event.target?.result as string)
    }
    reader.onerror = () => {
      reject(new Error('파일 읽기 실패'))
    }
    reader.readAsText(file, encoding)
  })
}
```

---

## 📝 수정된 파일 목록

### 1. `frontend/app/summarize/page.tsx`
- ✅ TXT/MD 파일 읽기 시 `UTF-8` 명시

### 2. `frontend/app/log-analysis/page.tsx`
- ✅ JSON 파일 읽기 시 `UTF-8` 명시
- ✅ CSV 파일 읽기 시 `UTF-8` 명시
- ✅ 기타 텍스트 파일 읽기 시 `UTF-8` 명시

### 3. `frontend/lib/encoding.ts` (신규)
- ✅ 인코딩 자동 감지 함수
- ✅ 인코딩 지정 파일 읽기 함수

---

## 🧪 테스트 방법

### 1. **한글 텍스트 파일 테스트**

```bash
# 테스트 파일 생성
echo "안녕하세요 ITEASY AI 플랫폼입니다." > test-korean.txt
```

1. Frontend `/summarize` 접속
2. `test-korean.txt` 업로드
3. 한글이 정상적으로 표시되는지 확인

### 2. **한글 JSON 파일 테스트**

```json
{
  "메시지": "안녕하세요",
  "사용자": "홍길동",
  "내용": "한글 인코딩 테스트입니다"
}
```

1. Frontend `/log-analysis` 접속
2. JSON 파일 업로드
3. 한글이 정상적으로 표시되는지 확인

### 3. **한글 CSV 파일 테스트**

```csv
이름,나이,직업
홍길동,30,개발자
김철수,25,디자이너
이영희,28,기획자
```

1. Frontend `/log-analysis` 접속
2. CSV 파일 업로드
3. 한글이 정상적으로 표시되는지 확인

---

## 🔧 서버 측 처리 (참고)

Langflow API도 한글을 올바르게 처리해야 합니다:

```typescript
// frontend/app/api/langflow/route.ts
export async function POST(request: Request) {
  const body = await request.json()
  
  const response = await fetch(`${langflowUrl}/api/v1/run/${flowId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json; charset=utf-8',  // ✅ charset 명시
      'x-api-key': apiKey,
    },
    body: JSON.stringify({
      input_value: body.input_value,
      // ...
    }),
  })
  
  // 응답도 UTF-8로 읽기
  const data = await response.json()
  return Response.json(data)
}
```

---

## ❓ 문제 해결 (Troubleshooting)

### Q1: 여전히 한글이 깨집니다

**A1**: 파일이 UTF-8이 아닌 다른 인코딩일 수 있습니다.

```bash
# 파일 인코딩 확인 (Mac/Linux)
file -I test.txt

# 인코딩 변환 (EUC-KR → UTF-8)
iconv -f EUC-KR -t UTF-8 test.txt > test-utf8.txt
```

### Q2: PDF 파일 한글이 깨집니다

**A2**: PDF는 `arrayBuffer`로 읽으므로 인코딩 문제가 없어야 합니다. PDF 자체에 폰트가 임베드되지 않았을 수 있습니다.

```typescript
// PDF 텍스트 추출 시 한글 처리 확인
const pageText = textContent.items
  .map((item: any) => item.str)
  .join(' ')  // 공백으로 연결하여 단어 분리 보장
```

### Q3: 브라우저마다 다르게 표시됩니다

**A3**: 모든 브라우저는 UTF-8을 지원하므로, FileReader에 `UTF-8`을 명시하면 일관되게 작동합니다.

---

## 📊 지원 인코딩

| 인코딩 | 지원 여부 | 비고 |
|--------|-----------|------|
| UTF-8 | ✅ | **권장** - 기본 인코딩 |
| UTF-16LE | ✅ | Windows 메모장 유니코드 |
| UTF-16BE | ✅ | Big Endian |
| EUC-KR | ⚠️ | 파일을 UTF-8로 변환 권장 |
| CP949 | ⚠️ | 파일을 UTF-8로 변환 권장 |

---

## 🎯 권장 사항

### 사용자에게 안내
```
파일 업로드 시:
1. ✅ UTF-8 인코딩 권장
2. ✅ 메모장에서 "다른 이름으로 저장" → 인코딩: UTF-8 선택
3. ⚠️ 한글 파일명도 가능하지만 영문 권장
```

### 프론트엔드 개발자에게
```
1. ✅ 항상 readAsText() 두 번째 매개변수에 'UTF-8' 명시
2. ✅ file.text() 대신 FileReader 사용
3. ✅ API 요청 시 Content-Type에 charset=utf-8 포함
4. ✅ 응답 처리 시에도 UTF-8 가정
```

---

## 📚 참고 자료

- [MDN FileReader](https://developer.mozilla.org/en-US/docs/Web/API/FileReader/readAsText)
- [UTF-8 Everywhere](http://utf8everywhere.org/)
- [PapaParse Encoding](https://www.papaparse.com/docs#config)

---

## ✅ 체크리스트

배포 전 확인:
- [ ] 모든 FileReader에 `UTF-8` 명시
- [ ] PapaParse에 `encoding: 'UTF-8'` 설정
- [ ] API 요청 헤더에 `charset=utf-8` 포함
- [ ] 한글 텍스트 파일로 테스트 완료
- [ ] 한글 JSON 파일로 테스트 완료
- [ ] 한글 CSV 파일로 테스트 완료
- [ ] 한글 PDF 파일로 테스트 완료

---

**적용 일자**: 2025-10-15  
**상태**: ✅ 해결 완료
