# 🔐 환경 변수 설정 가이드

## 📋 환경 파일 구조

```
.env          (개발 환경용 - Git에 포함됨)
.env.prod     (프로덕션 환경용 - Git에서 제외됨)
.env.example  (예시 파일)
```

---

## ⚠️ 중요: docker-compose 환경 변수 로딩

Docker Compose는 기본적으로 `.env` 파일을 자동으로 읽습니다.
`.env.prod` 파일을 사용하려면 **명시적으로 지정**해야 합니다!

### ❌ 잘못된 사용
```bash
docker-compose -f docker-compose.prod.yml up -d
# → .env 파일을 읽음 (의도하지 않음!)
```

### ✅ 올바른 사용
```bash
docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d
# → .env.prod 파일을 읽음
```

---

## 🔧 현재 상황 확인

### 1. 어떤 환경 변수가 적용되었는지 확인
```bash
docker-compose -f docker-compose.prod.yml config | grep PASSWORD
```

### 2. 실행 중인 컨테이너의 환경 변수 확인
```bash
docker exec extendlangflow-langflow-1 env | grep LANGFLOW_PASSWORD
docker exec extendlangflow-postgres-1 env | grep POSTGRES_PASSWORD
docker exec extendlangflow-grafana-1 env | grep GF_SECURITY_ADMIN_PASSWORD
```

---

## 🛠️ 해결 방법

### 방법 1: 자동 재설정 스크립트 사용 (권장)

```bash
# 1. .env.prod 파일 수정
nano .env.prod

# 2. 비밀번호 변경
POSTGRES_PASSWORD=새로운강력한비밀번호123!
LANGFLOW_PASSWORD=새로운강력한비밀번호456!
GRAFANA_PASSWORD=새로운강력한비밀번호789!

# 3. 자동 재설정 스크립트 실행
./reset-prod-env.sh
```

이 스크립트는:
- ✅ 기존 컨테이너와 볼륨 삭제
- ✅ .env.prod 파일로 새 컨테이너 생성
- ✅ 새 비밀번호로 서비스 초기화

---

### 방법 2: 수동 재설정

```bash
# 1. .env.prod 파일 수정
nano .env.prod

# 2. 기존 컨테이너 중지 및 삭제 (데이터도 삭제)
docker-compose -f docker-compose.prod.yml --env-file .env.prod down -v

# 3. 새 설정으로 시작
docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d

# 4. 상태 확인
docker-compose -f docker-compose.prod.yml --env-file .env.prod ps
```

---

### 방법 3: 데이터 보존하면서 재설정

**주의**: PostgreSQL, Langflow, Grafana는 볼륨에 데이터가 저장되어 있으면
새 비밀번호가 적용되지 않을 수 있습니다.

```bash
# 1. 컨테이너만 중지 (볼륨은 유지)
docker-compose -f docker-compose.prod.yml --env-file .env.prod down

# 2. 볼륨 확인
docker volume ls | grep langflow

# 3. 특정 서비스의 볼륨만 삭제 (예: Grafana)
docker volume rm extendlangflow_grafana-data

# 4. 재시작
docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d
```

---

## 📊 비밀번호 정책

### 권장 비밀번호 강도
- **최소 길이**: 16자 이상
- **조합**: 대문자 + 소문자 + 숫자 + 특수문자
- **특수문자 예**: `!@#$%^&*`
- **예시**: `MyS3cure!Passw0rd#2025`

### 생성 도구
```bash
# macOS/Linux에서 강력한 비밀번호 생성
openssl rand -base64 24

# 또는
LC_ALL=C tr -dc 'A-Za-z0-9!@#$%^&*' < /dev/urandom | head -c 20
```

---

## 🔐 .env.prod 파일 예시

```bash
# PostgreSQL Configuration
POSTGRES_USER=langflow
POSTGRES_PASSWORD=Str0ngP@ssw0rd!2025#DB
POSTGRES_DB=langflow

# Langflow Configuration
LANGFLOW_SUPERUSER=admin
LANGFLOW_PASSWORD=L@ngFlow#Secur3!2025

# Grafana Configuration
GRAFANA_USER=admin
GRAFANA_PASSWORD=Gr@f@na#Admin!2025

# Server Configuration
SERVER_IP=222.234.220.231
DOMAIN_NAME=222.234.220.231

# Security
NGINX_USER=admin
NGINX_PASSWORD=Nginx#Pr0xy!2025
```

---

## 🧪 테스트

### 1. Langflow 로그인 테스트
```bash
# 브라우저에서
http://localhost:7860

# 계정: admin / [설정한 LANGFLOW_PASSWORD]
```

### 2. Grafana 로그인 테스트
```bash
# 브라우저에서
http://localhost:3001

# 계정: admin / [설정한 GRAFANA_PASSWORD]
```

### 3. PostgreSQL 연결 테스트
```bash
docker exec -it extendlangflow-postgres-1 psql -U langflow -d langflow
# 비밀번호 입력: [설정한 POSTGRES_PASSWORD]
```

---

## ❓ 문제 해결

### Q1: 비밀번호를 변경했는데도 이전 비밀번호로 로그인됩니다

**A1**: Docker 볼륨에 이전 설정이 남아있습니다.

```bash
# 해결: 볼륨 삭제 후 재생성
docker-compose -f docker-compose.prod.yml --env-file .env.prod down -v
docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d
```

### Q2: docker-compose config에서 다른 비밀번호가 보입니다

**A2**: `--env-file` 옵션을 빼먹었습니다.

```bash
# 잘못된 방법
docker-compose -f docker-compose.prod.yml config

# 올바른 방법
docker-compose -f docker-compose.prod.yml --env-file .env.prod config
```

### Q3: 모든 서비스의 비밀번호를 한 번에 초기화하려면?

**A3**: `reset-prod-env.sh` 스크립트 사용

```bash
./reset-prod-env.sh
```

---

## 📝 deploy.sh 스크립트 수정 완료

배포 스크립트가 자동으로 `.env.prod` 파일을 사용하도록 수정되었습니다:

```bash
./deploy.sh
# → 자동으로 --env-file .env.prod 옵션 사용
```

---

## 🎯 체크리스트

배포 전 확인:
- [ ] .env.prod 파일 생성
- [ ] 모든 CHANGE_THIS_* 비밀번호 변경
- [ ] 비밀번호 16자 이상, 복잡도 충족
- [ ] .env.prod 파일 권한 확인 (`chmod 600 .env.prod`)
- [ ] .gitignore에 .env.prod 포함 확인
- [ ] --env-file .env.prod 옵션 사용 확인

---

## 🔒 보안 팁

1. **절대로 .env.prod를 Git에 커밋하지 마세요**
   ```bash
   git status
   # .env.prod가 나타나면 안됨
   ```

2. **비밀번호 관리자 사용**
   - 1Password, LastPass, Bitwarden 등
   - 팀원과 안전하게 공유

3. **정기적인 비밀번호 변경**
   - 3-6개월마다 변경 권장

4. **파일 권한 설정**
   ```bash
   chmod 600 .env.prod
   # 소유자만 읽기/쓰기 가능
   ```

---

**작성일**: 2025-10-15  
**상태**: ✅ deploy.sh 수정 완료, reset-prod-env.sh 추가
