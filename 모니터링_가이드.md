# 🚀 ITEASY AI 플랫폼 모니터링 가이드

## 📌 빠른 시작

### 1️⃣ Grafana 대시보드 접속

```
URL: http://localhost:3001
ID: admin
비밀번호: Zhtjgh*#20
```

### 2️⃣ 한글 대시보드 확인

로그인 후 좌측 메뉴 → **Dashboards** → **"ITEASY AI 플랫폼 모니터링"** 선택

또는 직접 링크:
- 영문 대시보드: http://localhost:3001/d/088f0398-138c-448b-a6bf-88f0444c8c78
- 한글 대시보드: http://localhost:3001/d/193702b8-6166-4cdd-ab34-93d4be37df01

---

## 📊 대시보드 구성

### 패널 1: 전체 컨테이너 메모리 사용량 (시계열)
- 모든 주요 컨테이너의 메모리 사용량을 시간별로 표시
- 색상별로 구분되어 한눈에 파악 가능

### 패널 2-3: Langflow 리소스
- **CPU 게이지**: 실시간 CPU 사용률 (0-100%)
  - 초록색: 정상 (0-50%)
  - 노란색: 주의 (50-80%)
  - 빨간색: 경고 (80-100%)
- **메모리 상태**: 현재 메모리 사용량 (MB)

### 패널 4-5: PostgreSQL 리소스
- CPU 게이지와 메모리 상태 표시
- 데이터베이스 부하 모니터링

### 패널 6: Langflow 네트워크 트래픽
- ⬇️ 수신 (RX): 들어오는 데이터
- ⬆️ 송신 (TX): 나가는 데이터
- 단위: bytes/sec

### 패널 7: PostgreSQL 디스크 I/O
- 📖 읽기: 디스크에서 읽는 속도
- ✍️ 쓰기: 디스크에 쓰는 속도

### 패널 8: Frontend 리소스
- Next.js 프론트엔드 CPU 사용량

### 패널 9: 전체 시스템 메모리 (파이 차트)
- 각 컨테이너별 메모리 점유율
- 어느 서비스가 메모리를 가장 많이 사용하는지 확인

---

## 🔍 Prometheus 쿼리 (이름 기반)

이제 **컨테이너 ID 없이 이름으로 조회** 가능합니다!

### 기본 쿼리

#### 1. Langflow 메모리 (MB)
```promql
container_memory_usage_bytes{container_name="langflow"} / 1024 / 1024
```

#### 2. Langflow CPU 사용률 (%)
```promql
rate(container_cpu_usage_seconds_total{container_name="langflow",cpu="total"}[1m]) * 100
```

#### 3. PostgreSQL 메모리 (MB)
```promql
container_memory_usage_bytes{container_name="postgres"} / 1024 / 1024
```

#### 4. PostgreSQL CPU 사용률 (%)
```promql
rate(container_cpu_usage_seconds_total{container_name="postgres",cpu="total"}[1m]) * 100
```

#### 5. Frontend 메모리 (MB)
```promql
container_memory_usage_bytes{container_name="frontend"} / 1024 / 1024
```

#### 6. 전체 컨테이너 목록 보기
```promql
container_memory_usage_bytes{container_name!=""}
```

### 네트워크 모니터링

#### 7. Langflow 수신 트래픽 (bytes/sec)
```promql
rate(container_network_receive_bytes_total{container_name="langflow"}[1m])
```

#### 8. Langflow 송신 트래픽 (bytes/sec)
```promql
rate(container_network_transmit_bytes_total{container_name="langflow"}[1m])
```

#### 9. 총 네트워크 트래픽
```promql
rate(container_network_receive_bytes_total{container_name="langflow"}[1m]) +
rate(container_network_transmit_bytes_total{container_name="langflow"}[1m])
```

### 디스크 I/O 모니터링

#### 10. PostgreSQL 읽기 속도 (bytes/sec)
```promql
rate(container_fs_reads_bytes_total{container_name="postgres"}[1m])
```

#### 11. PostgreSQL 쓰기 속도 (bytes/sec)
```promql
rate(container_fs_writes_bytes_total{container_name="postgres"}[1m])
```

### 고급 쿼리

#### 12. 전체 시스템 메모리 합계 (GB)
```promql
sum(container_memory_usage_bytes{container_name!=""}) / 1024 / 1024 / 1024
```

#### 13. 가장 많은 메모리를 사용하는 컨테이너
```promql
topk(3, container_memory_usage_bytes{container_name!=""})
```

#### 14. 평균 CPU 사용률 (최근 5분)
```promql
avg_over_time(rate(container_cpu_usage_seconds_total{container_name="langflow",cpu="total"}[1m])[5m:]) * 100
```

---

## 🎯 Prometheus UI 사용법

### 접속
```
http://localhost:9090
```

### 쿼리 실행 방법

1. **Graph** 메뉴 클릭
2. Expression 입력창에 위 쿼리 복사
3. **Execute** 버튼 클릭
4. **Graph** 탭에서 시각화 확인
5. **Table** 탭에서 수치 확인

### 시간 범위 조절
- 우측 상단 시간 선택기 사용
- 기본값: Last 1 hour
- 추천: Last 15 minutes (빠른 확인용)

---

## 🛠️ 컨테이너별 세부 정보

### 🚀 Langflow (AI 워크플로우 엔진)
- **정상 메모리**: 800-1500 MB
- **정상 CPU**: 0-10% (유휴 시)
- **주의사항**: AI 모델 실행 시 CPU 100% 도달 가능

### 🗄️ PostgreSQL (데이터베이스)
- **정상 메모리**: 30-100 MB
- **정상 CPU**: 0-5%
- **디스크 I/O**: 쿼리 발생 시 급증

### 🎨 Frontend (Next.js)
- **정상 메모리**: 400-700 MB
- **정상 CPU**: 0-5%
- **네트워크**: 사용자 접속 시 증가

### 📈 Grafana (모니터링 UI)
- **정상 메모리**: 80-150 MB
- **정상 CPU**: 0-3%

### 📊 Prometheus (메트릭 수집)
- **정상 메모리**: 30-80 MB
- **정상 CPU**: 0-2%

### 👀 cAdvisor (컨테이너 메트릭)
- **정상 메모리**: 20-80 MB
- **정상 CPU**: 1-5%

---

## 🚨 알람 설정 (추후 구성 가능)

### Prometheus Alerting Rules

다음은 알람 규칙 예시입니다 (`monitoring/alert-rules.yml`):

```yaml
groups:
  - name: container_alerts
    interval: 30s
    rules:
      - alert: HighMemoryUsage
        expr: container_memory_usage_bytes{container_name="langflow"} / 1024 / 1024 > 2000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Langflow 메모리 사용량 높음"
          description: "Langflow가 2GB 이상 메모리 사용 중"

      - alert: HighCPUUsage
        expr: rate(container_cpu_usage_seconds_total{container_name="langflow",cpu="total"}[1m]) * 100 > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Langflow CPU 사용률 높음"
          description: "Langflow CPU 사용률이 80% 초과"

      - alert: PostgreSQLDown
        expr: up{job="postgres"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQL 서비스 다운"
          description: "PostgreSQL이 응답하지 않음"
```

---

## 📖 참고 자료

### 컨테이너 이름 목록

| 서비스 | container_name | 설명 |
|--------|----------------|------|
| Langflow | `langflow` | AI 워크플로우 엔진 |
| PostgreSQL | `postgres` | 데이터베이스 |
| Frontend | `frontend` | Next.js 웹 인터페이스 |
| Grafana | `grafana` | 모니터링 대시보드 |
| Prometheus | `prometheus` | 메트릭 수집기 |
| PgAdmin | `pgadmin` | DB 관리 도구 |
| cAdvisor | `cadvisor` | 컨테이너 메트릭 수집 |

### 유용한 명령어

#### 현재 컨테이너 상태 확인
```bash
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
```

#### 실시간 리소스 사용량
```bash
docker stats
```

#### 특정 컨테이너 로그 보기
```bash
docker logs -f extendlangflow-langflow-1
```

#### 서비스 재시작
```bash
docker compose restart langflow
```

#### 전체 모니터링 스택 재시작
```bash
docker compose restart prometheus grafana cadvisor
```

---

## 💡 팁

### 1. 대시보드 자동 새로고침
- Grafana 우측 상단에서 **5s** (5초마다 갱신) 설정 가능
- 실시간 모니터링에 유용

### 2. 시간 범위 조정
- 최근 5분: 실시간 모니터링
- 최근 1시간: 트렌드 파악
- 최근 24시간: 일일 패턴 분석

### 3. 패널 확대
- 패널 제목 클릭 → **View** 선택
- 전체 화면으로 보기

### 4. 데이터 내보내기
- 패널 메뉴 → **Inspect** → **Data** → **Download CSV**

### 5. 대시보드 공유
- 우측 상단 **Share** 버튼
- 스냅샷 또는 JSON 내보내기 가능

---

## ❓ 문제 해결

### Q1: 대시보드에 데이터가 안 보여요
**A:** Prometheus와 cAdvisor 상태 확인
```bash
curl http://localhost:9090/api/v1/targets
docker ps | grep cadvisor
```

### Q2: 컨테이너 이름이 안 보여요
**A:** Prometheus 재시작
```bash
docker compose restart prometheus
```
20초 후 새 메트릭이 수집됩니다.

### Q3: Grafana 로그인이 안 돼요
**A:** 기본 계정 사용
```
ID: admin
비밀번호: Zhtjgh*#20
```

### Q4: 메트릭이 갑자기 사라졌어요
**A:** 컨테이너 재시작 시 일시적으로 발생 가능
```bash
docker compose ps
```
모든 서비스가 `Up` 상태인지 확인

---

## 🎓 다음 단계

1. ✅ **기본 모니터링 설정 완료**
2. ⏳ Langflow 워크플로우 생성
3. ⏳ 실제 워크로드로 부하 테스트
4. ⏳ Prometheus Alerting 규칙 추가
5. ⏳ Slack/이메일 알림 연동

---

**문서 작성일**: 2025-10-15  
**상태**: ✅ 모니터링 시스템 완전 구성 완료  
**다음 작업**: Langflow 워크플로우 생성 및 테스트
