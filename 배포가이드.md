# 🚀 ITEASY AI 플랫폼 - 프로덕션 배포 가이드

**서버 IP**: 222.234.220.231

---

## 📋 사전 요구사항

### 서버 환경
- **OS**: Ubuntu 20.04 LTS 이상 / CentOS 8 이상
- **CPU**: 최소 4 Core (권장 8 Core)
- **RAM**: 최소 8GB (권장 16GB)
- **Disk**: 최소 50GB 여유 공간
- **네트워크**: 공인 IP 할당 (222.234.220.231)

### 설치 필요 소프트웨어
```bash
# Docker
sudo apt update
sudo apt install -y docker.io

# Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker compose
sudo chmod +x /usr/local/bin/docker compose

# 확인
docker --version
docker compose --version
```

---

## 📦 1단계: 프로젝트 업로드

### 방법 1: Git 사용 (권장)
```bash
cd /opt
sudo git clone <repository-url> iteasy-platform
cd iteasy-platform
```

### 방법 2: 파일 압축 전송
```bash
# 로컬에서 압축
cd /Users/banhun/banhun28/extendLangFlow
tar -czf iteasy-platform.tar.gz \
  docker-compose.prod.yml \
  .env.prod \
  deploy.sh \
  frontend/ \
  nginx/ \
  monitoring/ \
  --exclude='frontend/node_modules' \
  --exclude='frontend/.next'

# 서버로 전송
scp iteasy-platform.tar.gz user@222.234.220.231:/opt/

# 서버에서 압축 해제
ssh user@222.234.220.231
cd /opt
sudo tar -xzf iteasy-platform.tar.gz
sudo mv extendLangFlow iteasy-platform
cd iteasy-platform
```

---

## 🔐 2단계: 환경 변수 설정

```bash
cd /opt/iteasy-platform

# .env.prod 파일 수정
sudo nano .env.prod
```

**필수 변경 사항**:
```bash
# PostgreSQL - 강력한 비밀번호로 변경
POSTGRES_PASSWORD=YOUR_STRONG_PASSWORD_HERE

# Langflow - 관리자 비밀번호 변경
LANGFLOW_PASSWORD=YOUR_LANGFLOW_PASSWORD_HERE

# Grafana - 관리자 비밀번호 변경
GRAFANA_PASSWORD=YOUR_GRAFANA_PASSWORD_HERE

# Nginx - Basic Auth 비밀번호 변경
NGINX_PASSWORD=YOUR_NGINX_PASSWORD_HERE
```

**비밀번호 권장 사항**:
- 최소 16자 이상
- 대소문자, 숫자, 특수문자 조합
- 각 서비스마다 다른 비밀번호 사용

---

## 🔥 3단계: 방화벽 설정

```bash
# UFW 사용 시
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw reload

# firewalld 사용 시
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --permanent --add-port=443/tcp
sudo firewall-cmd --reload

# 확인
sudo ufw status
# 또는
sudo firewall-cmd --list-all
```

**주의**: 내부 포트(3000, 7860, 9090 등)는 열지 마세요. Nginx로만 접근합니다.

---

## 🚀 4단계: 배포 실행

```bash
cd /opt/iteasy-platform

# 배포 스크립트 실행
sudo ./deploy.sh
```

배포 스크립트가 자동으로:
1. ✅ 환경 변수 검증
2. ✅ Docker 이미지 다운로드
3. ✅ Frontend 빌드
4. ✅ Nginx 인증 파일 생성
5. ✅ 모든 서비스 시작
6. ✅ 상태 확인

---

## 🔍 5단계: 배포 확인

### 서비스 상태 확인
```bash
# 컨테이너 상태
sudo docker compose -f docker-compose.prod.yml ps

# 모든 컨테이너가 "Up" 상태여야 함
```

### Health Check
```bash
curl http://222.234.220.231/health
# 출력: healthy
```

### 각 서비스 접속 테스트
```bash
# Frontend
curl -I http://222.234.220.231/

# Langflow
curl -I http://222.234.220.231/langflow/

# Grafana
curl -I http://222.234.220.231/grafana/
```

---

## 🌐 6단계: 접속 및 설정

### 📱 Frontend (메인 애플리케이션)
- **URL**: http://222.234.220.231
- **페이지**:
  - `/` - 홈
  - `/chatbot` - AI 챗봇
  - `/summarize` - 문서 요약
  - `/log-analysis` - 로그 분석
  - `/settings` - 설정

### 🤖 Langflow (AI 워크플로우)
- **URL**: http://222.234.220.231/langflow
- **계정**: admin / [.env.prod의 LANGFLOW_PASSWORD]
- **작업**:
  1. 로그인
  2. 3개 워크플로우 생성 (chatbot, summarize, log-analysis)
  3. Flow ID와 API Key 복사
  4. Frontend `/settings`에서 설정

### 📊 Grafana (모니터링)
- **URL**: http://222.234.220.231/grafana
- **계정**: admin / [.env.prod의 GRAFANA_PASSWORD]
- **대시보드**:
  - "ITEASY AI 플랫폼 모니터링" (한글)
  - "ITEASY AI Platform - Container Monitoring" (영문)

### 📈 Prometheus (메트릭)
- **URL**: http://222.234.220.231/prometheus
- **계정**: admin / [.env.prod의 NGINX_PASSWORD]
- **용도**: Grafana에서 데이터 소스로 사용

---

## 📊 7단계: 모니터링 설정

### Grafana 대시보드 임포트

대시보드가 자동으로 로드되지 않으면 수동 임포트:

```bash
# 서버에서
cd /opt/iteasy-platform/monitoring

# 한글 대시보드 임포트
curl -X POST \
  -H "Content-Type: application/json" \
  -u admin:YOUR_GRAFANA_PASSWORD \
  -d @grafana-dashboard-korean.json \
  http://localhost:3000/api/dashboards/db
```

또는 Grafana UI에서:
1. Dashboards → Import
2. Upload JSON file
3. `monitoring/grafana-dashboard-korean.json` 선택

---

## 🛠️ 운영 관리

### 로그 확인
```bash
# 전체 로그
sudo docker compose -f docker-compose.prod.yml logs

# 특정 서비스 로그
sudo docker compose -f docker-compose.prod.yml logs -f frontend
sudo docker compose -f docker-compose.prod.yml logs -f langflow
sudo docker compose -f docker-compose.prod.yml logs -f nginx

# 최근 100줄만
sudo docker compose -f docker-compose.prod.yml logs --tail=100
```

### 서비스 재시작
```bash
# 전체 재시작
sudo docker compose -f docker-compose.prod.yml restart

# 특정 서비스만
sudo docker compose -f docker-compose.prod.yml restart frontend
```

### 서비스 중지
```bash
# 중지 (데이터 보존)
sudo docker compose -f docker-compose.prod.yml stop

# 완전 삭제 (데이터 삭제)
sudo docker compose -f docker-compose.prod.yml down -v
```

### 업데이트
```bash
cd /opt/iteasy-platform

# 코드 업데이트 (Git 사용 시)
sudo git pull

# 이미지 업데이트
sudo docker compose -f docker-compose.prod.yml pull

# Frontend 재빌드
sudo docker compose -f docker-compose.prod.yml build frontend

# 재시작
sudo docker compose -f docker-compose.prod.yml up -d
```

---

## 🔒 보안 체크리스트

### 필수 사항
- [ ] `.env.prod`의 모든 기본 비밀번호 변경
- [ ] 방화벽에서 불필요한 포트 차단
- [ ] Nginx Basic Auth 활성화 (Prometheus)
- [ ] PostgreSQL 외부 접근 차단 (내부 네트워크만)
- [ ] 정기적인 Docker 이미지 업데이트

### 권장 사항
- [ ] SSL/TLS 인증서 설정 (Let's Encrypt)
- [ ] 로그 로테이션 설정
- [ ] 백업 자동화 (DB, volumes)
- [ ] 모니터링 알림 설정
- [ ] fail2ban 설치 (무차별 대입 공격 방지)

---

## 📦 백업

### 데이터 백업
```bash
# 볼륨 백업
sudo docker run --rm \
  -v iteasy-platform_postgres-data:/data \
  -v $(pwd):/backup \
  alpine tar czf /backup/postgres-backup-$(date +%Y%m%d).tar.gz /data

sudo docker run --rm \
  -v iteasy-platform_langflow-data:/data \
  -v $(pwd):/backup \
  alpine tar czf /backup/langflow-backup-$(date +%Y%m%d).tar.gz /data
```

### 복원
```bash
# 볼륨 복원
sudo docker run --rm \
  -v iteasy-platform_postgres-data:/data \
  -v $(pwd):/backup \
  alpine sh -c "cd / && tar xzf /backup/postgres-backup-YYYYMMDD.tar.gz"
```

---

## 🚨 문제 해결

### 문제 1: 컨테이너가 시작되지 않음
```bash
# 로그 확인
sudo docker compose -f docker-compose.prod.yml logs [service-name]

# 일반적 원인:
# 1. 메모리 부족 → 서버 리소스 확인
# 2. 포트 충돌 → 다른 서비스 중지
# 3. 권한 문제 → sudo 사용
```

### 문제 2: Frontend 접속 안됨
```bash
# Nginx 설정 확인
sudo docker exec iteasy-nginx nginx -t

# Frontend 로그
sudo docker compose -f docker-compose.prod.yml logs frontend

# 네트워크 확인
sudo docker network inspect iteasy-platform_iteasy-network
```

### 문제 3: Grafana 대시보드 데이터 없음
```bash
# Prometheus 타겟 확인
curl http://localhost:9090/api/v1/targets

# cAdvisor 메트릭 확인
curl http://localhost:8080/metrics | grep container_memory

# 데이터소스 재연결
# Grafana UI → Configuration → Data Sources → Prometheus → Test
```

### 문제 4: 메모리 부족
```bash
# 컨테이너 리소스 확인
sudo docker stats

# 불필요한 컨테이너 제거
sudo docker system prune -a

# Swap 설정 (Ubuntu)
sudo fallocate -l 4G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

---

## 📊 리소스 사용량 (예상)

| 서비스 | CPU | 메모리 | 디스크 |
|--------|-----|--------|--------|
| Frontend | 0.5 Core | 512 MB | 500 MB |
| Langflow | 1-2 Core | 1-2 GB | 2 GB |
| PostgreSQL | 0.5 Core | 256 MB | 5 GB |
| Nginx | 0.1 Core | 50 MB | 100 MB |
| Prometheus | 0.2 Core | 200 MB | 1 GB |
| Grafana | 0.2 Core | 200 MB | 500 MB |
| cAdvisor | 0.1 Core | 100 MB | 50 MB |
| **총합** | **3-4 Core** | **3-4 GB** | **10 GB** |

---

## 🎯 성능 최적화

### Nginx 캐싱 추가
```nginx
# nginx/conf.d/default.conf에 추가
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=1g;
```

### PostgreSQL 튜닝
```bash
# docker-compose.prod.yml의 postgres 섹션에 추가
command: postgres -c shared_buffers=256MB -c max_connections=100
```

### Prometheus 데이터 보관 기간 조정
```bash
# 이미 설정됨: --storage.tsdb.retention.time=30d
# 필요 시 15d로 줄여서 디스크 절약
```

---

## 📞 지원

**문제 발생 시**:
1. 로그 수집: `sudo docker compose -f docker-compose.prod.yml logs > error.log`
2. 시스템 정보: `docker info`, `free -h`, `df -h`
3. 네트워크 상태: `netstat -tulpn | grep -E "80|443|3000|7860"`

---

**배포 완료!** 🎉

이제 http://222.234.220.231 로 접속하여 ITEASY AI 플랫폼을 사용할 수 있습니다.
